<div class="certifications-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">
          <mat-icon class="title-icon">verified</mat-icon>
          Certificações
        </h1>
        <p class="page-subtitle">Gerencie suas certificações e credenciais</p>
      </div>
      
      <button 
        mat-raised-button 
        color="primary" 
        (click)="openCreateModal(certificationModal)"
        class="add-button">
        <mat-icon>add</mat-icon>
        Nova Certificação
      </button>
    </div>
  </div>

  <!-- Status Stats -->
  <div class="status-stats" *ngIf="getStatusStats().length > 0">
    <h3 class="stats-title">Status das Certificações</h3>
    <div class="stats-grid">
      <div 
        *ngFor="let stat of getStatusStats()" 
        class="stat-item"
        (click)="onStatusChange(stat.status)"
        [class.active]="selectedStatus === stat.status">
        <div class="stat-color" [style.background]="stat.color"></div>
        <span class="stat-label">
          {{ stat.status === 'active' ? 'Ativas' : stat.status === 'expired' ? 'Expiradas' : 'Sem Expiração' }}
        </span>
        <span class="stat-count">{{ stat.count }}</span>
      </div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="filters-section">
    <div class="filter-group">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Pesquisar certificações</mat-label>
        <input 
          matInput 
          [ngModel]="searchTerm"
          (ngModelChange)="onSearchChange($event)"
          placeholder="Digite para pesquisar...">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="status-field">
        <mat-label>Filtrar por status</mat-label>
        <mat-select 
          [value]="selectedStatus" 
          (selectionChange)="onStatusChange($event.value)">
          <mat-option value="all">Todos os status</mat-option>
          <mat-option value="active">Ativas</mat-option>
          <mat-option value="expired">Expiradas</mat-option>
          <mat-option value="no_expiration">Sem expiração</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    
    <div class="stats-badge" *ngIf="!loading">
      <span class="stat-count">{{ filteredCertifications.length }}</span>
      <span class="stat-label">certificação(ões)</span>
    </div>
  </div>

  <!-- Data Table -->
  <app-data-table
    [columns]="columns"
    [data]="filteredCertifications"
    [loading]="loading"
    [pageSize]="pageSize"
    [pageIndex]="pageIndex"
    [totalItems]="filteredCertifications.length"
    (edit)="openEditModal(certificationModal, $event)"
    (delete)="confirmDelete($event)"
    class="certifications-table">
    
    <!-- Custom templates -->
    <ng-container *ngTemplateOutlet="statusCell"></ng-container>
    <ng-container *ngTemplateOutlet="datesCell"></ng-container>
    <ng-container *ngTemplateOutlet="actionsCell"></ng-container>
  </app-data-table>

  <!-- Custom Cell Templates -->
  <ng-template #statusCell let-certification>
    <div class="status-container" *ngIf="certification">
      <mat-icon 
        class="status-icon"
        [style.color]="getStatusColor(certification)"
        [matTooltip]="getExpirationBadge(certification)">
        {{ getStatusIcon(certification) }}
      </mat-icon>
      <span 
        class="status-badge" 
        [style.background]="getStatusColor(certification)">
        {{ getStatusText(certification) }}
      </span>
    </div>
    <div class="status-container" *ngIf="!certification">
      <span class="status-badge unknown">
        Não informado
      </span>
    </div>
  </ng-template>

  <ng-template #datesCell let-certification>
    <div class="dates-container" *ngIf="certification">
      <div class="date-item">
        <mat-icon class="date-icon">event_available</mat-icon>
        <span class="date-text">{{ certification.issueDate | date:'dd/MM/yyyy' }}</span>
      </div>
      <div class="date-item" *ngIf="certification.expirationDate">
        <mat-icon class="date-icon">event_busy</mat-icon>
        <span class="date-text">{{ certification.expirationDate | date:'dd/MM/yyyy' }}</span>
      </div>
      <div class="date-item" *ngIf="!certification.expirationDate">
        <mat-icon class="date-icon">infinite</mat-icon>
        <span class="date-text">Sem expiração</span>
      </div>
    </div>
    <div class="dates-container" *ngIf="!certification">
      <span class="date-text unknown">Dados não disponíveis</span>
    </div>
  </ng-template>

  <ng-template #actionsCell let-certification>
    <div class="actions-container" *ngIf="certification">
      <button 
        *ngIf="certification.credentialUrl"
        mat-icon-button 
        color="primary"
        (click)="openCredentialUrl(certification.credentialUrl!)"
        matTooltip="Ver credencial">
        <mat-icon>link</mat-icon>
      </button>
      <button 
        *ngIf="certification.credentialId"
        mat-icon-button 
        color="accent"
        matTooltip="ID: {{ certification.credentialId }}">
        <mat-icon>badge</mat-icon>
      </button>
    </div>
  </ng-template>

  <!-- Certification Modal -->
  <ng-template #certificationModal>
    <div class="modal-header">
      <h2 mat-dialog-title>
        <mat-icon>{{ isEditMode ? 'edit' : 'add' }}</mat-icon>
        {{ isEditMode ? 'Editar' : 'Nova' }} Certificação
      </h2>
      <button mat-icon-button mat-dialog-close class="close-button">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <mat-dialog-content>
      <form [formGroup]="certificationForm" class="certification-form">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nome da Certificação *</mat-label>
          <input 
            matInput 
            formControlName="name" 
            placeholder="Ex: AWS Certified Solutions Architect, Scrum Master...">
          <mat-icon matSuffix>verified</mat-icon>
          <mat-error *ngIf="certificationForm.get('name')?.hasError('required')">
            Nome da certificação é obrigatório
          </mat-error>
          <mat-error *ngIf="certificationForm.get('name')?.hasError('minlength')">
            Mínimo 2 caracteres
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Organização Emissora *</mat-label>
          <input 
            matInput 
            formControlName="issuingOrganization" 
            placeholder="Ex: Amazon Web Services, Scrum.org, Microsoft...">
          <mat-icon matSuffix>business</mat-icon>
          <mat-error *ngIf="certificationForm.get('issuingOrganization')?.hasError('required')">
            Organização emissora é obrigatória
          </mat-error>
        </mat-form-field>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Data de Emissão *</mat-label>
            <input matInput [matDatepicker]="issuePicker" formControlName="issueDate">
            <mat-datepicker-toggle matSuffix [for]="issuePicker"></mat-datepicker-toggle>
            <mat-datepicker #issuePicker></mat-datepicker>
            <mat-error *ngIf="certificationForm.get('issueDate')?.hasError('required')">
              Data de emissão é obrigatória
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Data de Expiração</mat-label>
            <input matInput [matDatepicker]="expirationPicker" formControlName="expirationDate">
            <mat-datepicker-toggle matSuffix [for]="expirationPicker"></mat-datepicker-toggle>
            <mat-datepicker #expirationPicker></mat-datepicker>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>ID da Credencial</mat-label>
            <input 
              matInput 
              formControlName="credentialId" 
              placeholder="Número ou código da certificação">
            <mat-icon matSuffix>badge</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>URL da Credencial</mat-label>
            <input 
              matInput 
              formControlName="credentialUrl" 
              placeholder="https://...">
            <mat-icon matSuffix>link</mat-icon>
          </mat-form-field>
        </div>

        <!-- Preview da certificação -->
        <div class="certification-preview" *ngIf="certificationForm.get('name')?.value && certificationForm.get('issuingOrganization')?.value">
          <h4 class="preview-title">Preview:</h4>
          <div class="preview-content">
            <div class="preview-header">
              <h5 class="preview-name">{{ certificationForm.get('name')?.value }}</h5>
              <div class="preview-status">
                <mat-icon 
                  class="preview-icon"
                  [style.color]="getPreviewStatusColor()">
                  {{ getPreviewStatusIcon() }}
                </mat-icon>
                <span class="status-badge preview-badge" [style.background]="getPreviewStatusColor()">
                  {{ getPreviewStatusText() }}
                </span>
              </div>
            </div>
            <p class="preview-organization">{{ certificationForm.get('issuingOrganization')?.value }}</p>
            <div class="preview-dates">
              <div class="preview-date">
                <mat-icon class="preview-icon">event_available</mat-icon>
                <span>Emitida em: {{ certificationForm.get('issueDate')?.value | date:'dd/MM/yyyy' }}</span>
              </div>
              <div class="preview-date" *ngIf="certificationForm.get('expirationDate')?.value">
                <mat-icon class="preview-icon">event_busy</mat-icon>
                <span>Expira em: {{ certificationForm.get('expirationDate')?.value | date:'dd/MM/yyyy' }}</span>
              </div>
              <div class="preview-date" *ngIf="!certificationForm.get('expirationDate')?.value">
                <mat-icon class="preview-icon">infinite</mat-icon>
                <span>Sem data de expiração</span>
              </div>
            </div>
            <div class="preview-credentials" *ngIf="certificationForm.get('credentialId')?.value || certificationForm.get('credentialUrl')?.value">
              <p class="preview-credential-id" *ngIf="certificationForm.get('credentialId')?.value">
                <strong>ID:</strong> {{ certificationForm.get('credentialId')?.value }}
              </p>
              <p class="preview-credential-url" *ngIf="certificationForm.get('credentialUrl')?.value">
                <strong>URL:</strong> {{ certificationForm.get('credentialUrl')?.value }}
              </p>
            </div>
          </div>
        </div>
      </form>
    </mat-dialog-content>

    <mat-dialog-actions align="end">
      <button mat-button mat-dialog-close class="cancel-button">Cancelar</button>
      <button 
        mat-raised-button 
        color="primary" 
        (click)="saveCertification()"
        [disabled]="!certificationForm.valid"
        class="save-button">
        <mat-icon>{{ isEditMode ? 'save' : 'add' }}</mat-icon>
        {{ isEditMode ? 'Atualizar' : 'Criar' }} Certificação
      </button>
    </mat-dialog-actions>
  </ng-template>
</div>